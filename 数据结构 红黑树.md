## 红黑树



### 一.性质

1.每个结点非黑即红

2.根结点是黑色

**3.叶结点(NIL)是黑色**【总是喜欢被大家忽略的一条，但是却有很大的作用】

4.如果一个结点是红色，则它的两个子结点都是黑色的

5.从根结点出发到所有叶结点路径上，黑色结点数量相同

### 二.特性

1.从根到叶子的最长的可能路径不多于最短的可能路径的两倍长

以黑色结点个数为3举例

最短路径:黑—>黑—>黑—>NIL

最长路径:黑—>红—>黑—>红—>黑—>红—>NIL

2.红黑树相对于AVL树来说，牺牲了部分平衡性以换取插入/删除操作时少量的旋转操作，整体来说性能要优于AVL树

### 三.调整策略

#### 1.插入调整站在`祖父结点`看[两种情况]

​	首先我们要搞清楚插入的时候一定是`插入了红色`，在插入之前树是平衡的，如果插入黑色，那么插入之后树一定是不平衡的[破坏第5条性质:从根结点出发到所有叶结点路径上，黑色结点数量相同]，所以我们在插入的时候一定是红色，这样才有可能平衡

​	当插入结点的父亲结点是黑色，我们不需要做任何调整，所以只有在**插入结点的父结点是红色**的时候[违反第4条性质:如果一个结点是红色，则它的两个子结点都是黑色的]**才需要做调整**

这时我们分两种情况

**1>叔父结点为红色**

![屏幕快照 2018-10-09 下午2.34.08](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午2.34.08.png)

​	为了使18与20的颜色不同，我们可以直接修改uncle(1)和father(20)的颜色，1与20变为黑色之后，再将15变成红色即可

​	**在红黑树调整策略的学习过程中，一定要把不平衡情况看成是子树，将上图看为整棵树的一部分**，修改之后并不能保证15结点的父结点不是红色，所以将15看成x，继续向上层做迭代

**红色上顶**

**(1)父结点与叔父结点改为黑色**

**(2)祖父结点改为红色**

**(3)祖父结点为x结点向上层迭代**

结果图如下:

由于我们并不知道a是什么颜色的，如果a是红色的，仍需再做修改，所以一定要记得向上迭代

![屏幕快照 2018-10-09 下午2.36.08](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午2.36.08.png)

**2>叔父结点不为红色**

![屏幕快照 2018-10-09 下午2.48.19](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午2.48.19.png)

​	我们可以将上图两个红色相连看成是AVL树种LL型失衡的情况，此时，图中左右黑色结点的个数相同，只有15与10(x)结点是违反第四条性质的[如果一个结点是红色，则它的两个子结点都是黑色的]，那么我们要更改哪个结点的颜色呢？

​	在上文中我已经说到了，要把每一种情况都看成整个树的一部分，那么假设每个叶子结点都有子树，并且结点20也是整棵树的子树，那么我们就可以分析到底要改哪个结点了

![屏幕快照 2018-10-09 下午1.31.34](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午1.31.34.png)

设结点a的左右子树的黑色结点个数都为p，那么结点c、d、e、f、g、h、i、j、k的黑色结点个数都为p - 2

(1)结点5的颜色能改吗?由于10是红色，根据第4条性质，所以5的颜色一定为黑色，我们并不知道f和g是不是红色的，如果是红色的，将结点5改成红色就破坏了规则，而不是维护，不能改

(2)结点13的颜色能改吗？同结点5的分析，不能改

(3)结点19的颜色能改吗？结点19的父结点是红色，所以19一定是黑色，但是黑色的子结点e的颜色是不确定的，e为哪个颜色都满足需求，如果e为红色，19也改为红色的话，违反性质4，所以19的颜色不能改

(4)结点25的颜色能改吗？同如上的分析，不能改变25的颜色

所以图片中只有10，15，20的颜色能做更改，但是无论如何变换颜色，都不能使它平衡，那么我们就将它看成LL型，拽着结点20右旋

![屏幕快照 2018-10-09 下午1.03.14](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午1.03.14.png)

​	此时，结点15的左子树黑色结点个数为p - 1个，结点15的右子树黑色结点个数为p个，现在右子树比左子树多一个黑色结点，那么这个时候就很好修改了

将结点15改成黑色，左子树现在满足p个黑色结点，但是右子树多了一个结点，就将20改成红色

![屏幕快照 2018-10-09 下午1.11.16](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午1.11.16.png)

总结一下**LL型**的调整策略

**(1)拽着X的祖父结点右旋**

**(2)X的父亲结点改成黑色**

**(3)X的兄弟结点改成红色**

其余情况均可以调整成第2>种情况，请自行推导练习，如果推导不出来的话，可以看我下面的逐一分析









**LR型**

![屏幕快照 2018-10-09 下午3.01.35](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午3.01.35.png)

结点10， 18， 19，25的子结点颜色不确定，不能更改它们的颜色

两个红色结点相连的时候，旋转不会改变子路径黑色结点的个数

拽着结点15向左(L)旋转，变成LL型

![屏幕快照 2018-10-09 下午3.15.47](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午3.15.47.png)

根据上面的LL型情况推得，拽着结点20右旋

![屏幕快照 2018-10-09 下午3.31.12](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午3.31.12.png)

最后变换颜色

![屏幕快照 2018-10-09 下午3.32.41](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午3.32.41.png)

总结一下**LR**型的调整策略

**(1)拽着X的父亲结点左旋，转换成LL型**

(2)接下来的步骤与LL型调整步骤相同

**(1)拽着原来X结点的祖父结点右旋**

**(2)X的结点改成黑色**

**(3)X的右孩子结点改成红色**





**RR型**

![屏幕快照 2018-10-09 下午4.01.30](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午4.01.30.png)

由于10、17、19、25的子树颜色未知，所以我们不能随意更改它们的颜色，而此时更改15、18、20的颜色并不能使树的黑色个数得到平衡，于是我们左旋

![屏幕快照 2018-10-09 下午4.49.14](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午4.49.14.png)由于左右子树的黑色结点个数不等，接下来我们修改颜色

![屏幕快照 2018-10-09 下午4.48.32](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午4.48.32.png)

总结一下**RR型**的调整策略

**(1)拽着X的祖父结点左旋**

**(2)X的父亲结点改成黑色**

**(3)X的兄弟结点改成红色**





**RL型**

 ![屏幕快照 2018-10-09 下午6.15.44](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午6.15.44.png)

由于10、17、19、25的子结点颜色不知道，所以它们的颜色不能随便更改，而更改15、18、20颜色不能使之平衡

拽着结点20右旋

![屏幕快照 2018-10-09 下午6.16.49](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午6.16.49.png)

拽着结点15左旋

![屏幕快照 2018-10-09 下午6.33.01](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午6.33.01.png)

将结点18改成黑色，结点15改成红色

![屏幕快照 2018-10-09 下午6.34.18](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午6.34.18.png)

总结一下RL型调整策略

**(1)拽着X的父亲结点右旋，转换成RR型**

(2)接下来的步骤与RR型调整步骤相同

**(1)拽着原来X结点的祖父结点左旋**

**(2)X的结点改成黑色**

**(3)X的左孩子结点改成红色**





最后我们可以看出，插入的调整策略无非两种(1)叔父结点与父结点都为红色(2)叔父结点为黑色，父结点为红色

在第二种调整策略中4种小情况的推导思想一样，为了方便读者阅读，每种小的情况都进行了推演





#### 2.删除调整站在`父结点`看[三种情况]

​	与AVL的删除操作相似，如果有两个子结点，可以转化成删除一个子结点，如果两个子结点都为NIL，那么把其中一个NIL当作子结点就可以了，那么下面我们只讨论有一个子结点的删除操作

​	首先，我们讨论几种简单的情况。

(1)待删除结点为红色，那么它的子结点和父结点一定都为黑色，只需要把待删除结点删掉，把待删除结点的子结点上移至待删除结点的父结点处即可

(2)待删除结点为黑色，但是其子结点为红色，只需要将待删除结点删掉，把待删除结点的子结点替换上来将子结点改为黑色即可。

​	接下来，我们引入**双重黑色**的概念，当待删除结点与其子结点都为黑色的时候，将待删除结点删掉，子结点替换上来之后，路径中少了一个黑色结点，我们把它的子结点叫做双重黑色结点，所以如下的结点里面我们把x结点记为双重黑色结点，黑色次数记为两次。

也就是说**只有出现双重黑色的时候才需要调整** 当前结点是黑色，下面子结点也是黑色

根据上面的插入讨论，下面我们来讨论三种删除双重黑色结点的情况

**1>兄弟结点为黑色，兄弟结点的子结点都为黑色**

![屏幕快照 2018-10-09 下午7.22.23](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午7.22.23.png)哪个结点能改？

结点8、12、95的子结点颜色未知，不能向下进行破坏操作

那么在结点9、a、95中怎么更改才能将95(X)减为一重黑呢？

**(1)将brother改成红色，那么左子树的黑色结点个数少一**

**(2)将a加一重黑色，那么X不仅可以减一重黑，而且左右子树的黑色结点个数重新达到平衡**

注意:是a加一重黑色，而不是改成黑色，因为a有可能是黑色也有可能是红色，如果a为黑色，那么修改之后a变成二重黑色，需要向上迭代，继续做删除操作的调整

**(3)检查结点a是否需要向上迭代**

![屏幕快照 2018-10-09 下午7.25.28](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午7.25.28.png)**2>兄弟结点为黑色，兄弟结点的子结点为红色[LL型或RR型]**

**RR型**

**当结点38为红色**

![屏幕快照 2018-10-09 下午9.17.50](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午9.17.50.png)



​	我们想消除X的二重黑，这个时候结点28(X)的子结点颜色不确定，不能向下更改，只能求助父亲结点进行更改，但是如果更改结点38来减少X的二重黑，则结点38的右子树的黑色结点个数会整体加一。

如上所述，我们拽结点38左旋

![屏幕快照 2018-10-09 下午9.32.34](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午9.32.34.png)

旋转之后我们可以看出来51的左子树的左子树已经不平衡了，那么为了使之重新平衡，我们应该怎么做呢？

我们看到旋转之前结点38的左右子树为p - 1个黑色结点，所以现在为了使之平衡，可以将结点28(X)减一重黑

结果一:

![屏幕快照 2018-10-09 下午10.39.24](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.39.24.png)

结果二:

根据下面的总结产生的结果，可以阅读完**结点38为黑色**再行查看

![屏幕快照 2018-10-09 下午10.37.15](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.37.15.png)

**当结点38为黑色**

![屏幕快照 2018-10-09 下午10.06.30](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.06.30.png)			   		
​	我们想消除X的二重黑，这个时候结点28(X)的子结点颜色不确定，不能向下更改，只能求助父亲结点进行更改，但是如果更改结点38来减少X的二重黑，则结点38的右子树的黑色结点个数会整体加一。

如上所述，我们拽结点38左旋

![屏幕快照 2018-10-09 下午10.14.05](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.14.05.png)

​	我们可以看到现在的不平衡情况如上图所示，我们已经知道结点48由于不确定性不能更改，结点64、85由于确定性可以更改，现将X减一重黑，72改成黑色即可

![屏幕快照 2018-10-09 下午10.34.09](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.34.09.png)



**将结点38的两种颜色统一为一种操作**

**(1)将X的父结点左旋(拽着结点38左旋)**

**(2)将X的原兄弟结点改成父结点的颜色(在情况一中:将51改成红色；在情况二中:无需改变)**

**(3)将原父结点改成黑色(在情况一中:将38改成黑色；在情况二中:无需改变)**

**(4)X减一重黑色**

**(5)将原兄弟结点的右子结点改成黑色(在情况一中:将72改成黑色；在情况二中:将72改成黑色)**

将上述问题整合成情况2>的通用模型如下:

![屏幕快照 2018-10-09 下午10.49.03](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午10.49.03.png)

**LL型**

![屏幕快照 2018-10-10 上午9.06.45](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-10 上午9.06.45.png)

(1)拽着X的父结点右旋



**3>兄弟结点为黑色，兄弟结点的子结点为红色[LR型或RL型]**

**RL型**

在AVL树中，我们将RL型转换成RR型，再用RR型的操作进行转换，在红黑树中我们用同样的思想完成调换

![屏幕快照 2018-10-09 下午11.20.59](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午11.20.59.png)

我们想将RL型转换成RR型，则拽着结点72右旋

为使其变成RR型，将51改成色，将51改成黑色，将72改成红色，生成RR型

随后的操作如情况2>

![屏幕快照 2018-10-09 下午11.25.30](/Users/hanxu/Desktop/blog图片文件/屏幕快照 2018-10-09 下午11.25.30.png)          

